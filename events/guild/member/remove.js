import { guild } from "../../../client.js";
import CONSTANTS from "../../../common/CONSTANTS.js";
import log from "../../../common/moderation/logging.js";
import { closeModmail, getThreadFromMember } from "../../../common/modmail.js";

/** @type {import("../../../common/types/event").default<"guildMemberAdd">} */
export default async function event(member) {
	if (member.guild.id !== process.env.GUILD_ID) return;
	await log(`ðŸ’¨ Member ${member.toString()} left!`, "members");

	const byes = [
		`Welpâ€¦ **${member.user.username}** decided to leaveâ€¦ what a shameâ€¦`,
		`Ahhâ€¦ **${member.user.username}** left usâ€¦ hope theyâ€™ll have safe travels!`,
		`There goes another, bye **${member.user.username}**!`,
		`Oop, **${member.user.username}** leftâ€¦ will they ever come back?`,
		`Can we get an F in the chat for **${member.user.username}**? They left!`,
		`Ope, **${member.user.username}** got eaten by an evil kumquat and left!`,
	];

	const banned = await guild.bans
		.fetch(member)
		.then((partialBan) => {
			if (partialBan.partial) return partialBan.fetch();
			return partialBan;
		})
		.catch(() => {});

	const bans = [
		`Oofâ€¦ **${member.user.username}** got bannedâ€¦`,
		`Thereâ€™s no turning back for **${member.user.username}**â€¦`,
		`I don't think this was the best place for **${member.user.username}**â€¦`,
		`Oop, **${member.user.username}** angered the mods!`,
		`**${member.user.username}** broke the rules and took an L`,
		`**${member.user.username}** was banned ~~(he talked about opacity slider too much)~~`,
	];

	const promises = [
		CONSTANTS.channels.airport?.send(
			(banned
				? bans[Math.floor(Math.random() * bans.length)]
				: byes[Math.floor(Math.random() * byes.length)]) || "",
		),
		getThreadFromMember(member).then(async (thread) => {
			if (thread) closeModmail(thread, member.user, "Member left");
		}),
	];

	await Promise.all(promises);
}
